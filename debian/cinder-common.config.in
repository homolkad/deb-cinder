#!/bin/sh

set -e

. /usr/share/debconf/confmodule
CINDER_CONF=/etc/cinder/cinder.conf
CINDER_API=/etc/cinder/api-paste.ini

#PKGOS-INCLUDE#

pkgos_var_user_group cinder
pkgos_dbc_read_conf -pkg cinder-common ${CINDER_CONF} DEFAULT sql_connection cinder $@
pkgos_rabbit_read_conf ${CINDER_CONF} DEFAULT cinder
pkgos_read_admin_creds ${CINDER_API} filter:authtoken cinder

pkgos_inifile get ${CINDER_CONF} DEFAULT volume_group
if [ -n "${RET}" ] && [ ! "${RET}" = "NOT_FOUND" ] ; then
	db_set cinder/volume_group "${RET}"
else
	db_get cinder/volume_group
	if [ -z "${RET}" ] && [ -x /sbin/vgdisplay ] ; then
		# Since we have no prior value, try to guess it from vgdisplay
		VGDISP=`vgdisplay -c | head -n 1`
		if [ -n "${VGDISP}" ] ; then
			VGNAME=`echo ${VGDISP} | cut -d: -f1`
			db_set cinder/volume_group ${VGNAME}
		fi
	fi
fi
db_input high cinder/volume_group || true
db_go

exit 0
